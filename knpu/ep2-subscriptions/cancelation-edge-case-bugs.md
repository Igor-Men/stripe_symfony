# Cancelation Edge Case Bugs

As easy as cancelling and reactivating seems, there are 2 minor edge cases which have caused us problems in the past, that I want to get fixed right now. First, go to the Stripe API docs, and go down to subscription. You'll notice that one of the fields here is called status, which is a number of different values. The most important ones for us are active, past due, which means it's still in an active state, but we're having problems charging their card, and cancel. We're going to talk a lot more about what happens when we have problems charging on renewals in a little bit.

I was going to say, Max stepped out, [inaudible 00:00:47] upstairs. [inaudible 00:00:49] around like [inaudible 00:00:51] the toilet, and the toilet's [inaudible 00:00:52] in there. In case you wanted to look.

[inaudible 00:00:54] I don't have time for this. Here's problem number 1. When Stripe tries to renew a subscription and charge the user's credit card, that might fail. Here's the first problem. As soon as Stripe is ready to charge your user for a renewal, it creates an invoice. Then, Stripe tries to charge that invoice. If it fails, it tries a few more times before it finally cancels the subscription. We'll talk more about that later.

Here's the problem. At the end of the month, Stripe will try to charge your user for the renewal. To do that, it will create an invoice and then charge that invoice. If, for some reason, the user's credit card can't be charged, the invoice remains created and Stripe will try to charge that invoice a few more times. That's something we'll talk about a lot more in a few minutes.

Here's the problem. If the invoice has been created, and we're having problems charging the user's credit card, and then the user goes to our site and cancels, since we're cancelling at the period end, the invoice won't actually get deleted and Stripe will continue to try to charge that invoice a few more times, even though your user has said they want to cancel. The way to fix that is to fully cancel the user's subscription, which will close the invoice instead of cancelling it at period end, like we have been so far.

The second edge case is very, very similar. It deals with web hooks, which we're going to talk about in a second. At the end of the month, one hour before ... In this case, we need to fully cancel the user's subscription. Here's how we're going to do it. First, set a variable called cancel at period end to true, and down below we will cancel at period end. Now, if the subscription status equals past due, then it means that that invoice has been created and we're having problems charging it.

This means that we need to say cancel at period end equals false. When we do that, we will cancel the subscription immediately and that will close the invoice and not charge the user anymore. Now there's one other, small case where this exact same problem happens. At the end of the month, one hour before we need to charge the user, Stripe creates the invoice. It then waits one hour, and then tries to charge the user. Within that one hour, if your user cancels their subscription, then we also need to close that invoice. Else, the user will get charged even though they've canceled their subscription.

This one's even trickier, because we basically need to see if the user is in that one hour window. Their subscription status is not past due yet, because we haven't actually tried to charge them. To figure that out, create a new variable called current period end, and set that to a new date-time, then AT symbol, set to sub, arrow, subscription, arrow, current period end. What we're doing is we're reading the current period end date, which is a time stamp, and then turning that into a date-time object.

We're doing that so we can say else if current period end is less than new date-time plus one hour, then this means that we're probably in that window, and we should cancel at period end equals false. An easy way of thinking of this is, if they're pretty close to the end of their period, they probably want to fully cancel, and so we'll just be careful.

The reasons behind that are pretty subtle, but it's a pretty easy fix. The only other complication is it means that when the user clicks the cancel subscription button, we might be cancelling their subscription fully, immediately, so we need to update our database to reflect that. To make that happen, first return the Stripe subscription from the cancel subscription method, and then, the profile controller, we can say, Stripe subscription equals, when we call cancel subscription.

Then we can use that status field to know whether or not the subscription has actually been cancelled, or whether or not it's active. In other words, if Stripe subscription arrow status equals cancelled, then we know we just fully cancelled the user's subscription, else, we're cancelling at the period end so we'll just call deactivate. For fully cancelling it, let's go into the subscription class, and add a new public function called cancel. Here we want to set this ends at to right now, and set the billing period to null. The profile controller, call the subscription, arrow, cancel. That should take care of it.

This is actually quite a bit harder to test. You can temporarily change your code to try to trigger this line. For now, we're just going to make sure that we didn't break anything. By making sure, we're going to hit cancel, perfect, and reactivate. That's why handling subscriptions is hard.
