# Subscription Canceled Webhook

So the first web hook that we need to handle is this customer,, dot, subscription, dot, deleted type, so that if a subscription gets deleted, most likely because we weren't able to charge their card, we can actually update the subscription on our side to be canceled.

So the way we're going to do this is by creating a new controller, a new end point. In apple/controller create a new [inaudible 00:00:31] request called "Web hook Controller". Make this extend a base controller class by having this project which just has a couple of shortcuts.

I'm going to set up a new end point. A function called stripe web hook action with the URL of slash, web hooks, slash, stripe. This will be the end point that eventually we're going to configure with stripe so that when there is a web hook, stripe will make a request to this URL.

Now this is going to be tricky at first because we're coding locally so it's going to be hard to test this controller, but we'll talk about that in a second.

Make sure you auto complete the "@" route so you get the you statement above on top. Just get started on return new response from eight to give you foundation. Awesome, so it's just enough that I can go back here and text out slash, web hooks, slash, stripe and we should know that the end point's working.

So thanks to requests, then, we know what they payload looks like that sent in those web hooks. In fact, what we're looking at here is an event. So we're going to decode this body and get this event ID first.

So to do that we'll say date equals j-son decode, and then we need the body of request. So I'll add request as an argument, that added the you statement up top, and then in symphony you can say request arrow get content. Now, that's true as the second argument so that gives me an associate of array. If you're not using symphony, there's a standard way in PHP to get the body of the request.

Second, it shouldn't happen, but if data is null, that means we were sent invalid j-son. We'll throw a new exception so that we know if that happens. Bad j-son body from stripe. Even excel spell exception correctly.

Finally we get the event ID which is data, lobster bracket, ID, redeem this ID off of here. Now the reason I'm doing that is, ultimately I need to read the fields down here. I need to find out what subscription this is so we can look it up in our database and make a change to it. Instead of reading the j-son body directly, we're going to use this event ID and actually use stripe's API to fetch an event object. What that's going to give me back is actually identical to what's in the web hook, so seemingly there's no advantage doing this. The reason it's recommended is that by using the ID and then asking stripe via it's API for that event, we can rule out the possibility that there's some third party attack going on that is trying to send fake web hooks to us.

Since we always make all of our API requests through our Stripe client class, lets open it, go to the bottom, make a new public function called "FindEvent" with an event ID argument.

This would be pretty simple, we're just going to return slash Stripe slash event colon, colon, retrieve. The same way we've been fetching all of the objects from Stripe. No we will return us a Stripe event. Now our [inaudible 00:04:56] we can say Stripe event equals this error get stripe underscore client arrow find event pass the event ID. This is an invalid event ID that will turn a reception right there and will start handling it.

Now the first event type we are going to be handling is the customer subscription deleted but we are going to be handling other event types in the future so I'm going to start with a switch K statement. We're going to switch on stripe, event, arrow, type and just as reference here if you look at the event object, this is the field that's going to hold what type of event it is. Of course the first one that we want is customer, dot, subscription, dot, deleted. When this happens we are going to fully cancel user subscription and then break. If we receive and event of another type, we're not supporting that so I'm going to throw a new exception, says unexpected web hook from stripe. That's in the event type. The reason that works is that when we set up our web hooks, ultimately we are going to set up our web hooks so that instead of it sending us all of the events, it's only going to send us specific events that we asked for. If we get into this default it means that something went wrong. Either we configured our web hook incorrectly or there's a bug in our code so I want to throw in an exception.

[inaudible 00:07:02] we return just a nice message like, event handle, stripe event, arrow, type. The important thing here is that we're returning 200 status code when things are successful. If you return a non 200 status code from a web hook endpoint, Stripe's going to keep trying to send you that web hook up to 100 times. So buy returning 200 status code you say, everything's okay, stop sending us that.

Now to actually cancel the user subscription we first need to find the subscription in our database. We can do that if we look at our body by using data, dot, object, dot, ID because for this type of event that's going to be the ID of our subscription. Let's start with stripe subscription ID equals stripe event, arrow, data, arrow, object ID. Next we know that our subscription entity in the data base has a striped subscription ID on it, so we just need to query from subscription that matches that. I'm actually going to put this in a new function so start with subscription equals this, arrow, find, subscription, and pass it stripe subscription ID. This function doesn't exist yet so I'm going to make a new private function down on the bottom called find subscription that takes an argument.

The reason I'm putting this into a private function is that I know that I'm going to need to do this a few other times before we're done with this web hook controller. Here query fit subscription by saying this get [inaudible 00:09:03], get repository, app bundle subscription, then find one by we'll pass that an array with stripe subscription ID set to that stripe subscription ID variable. Now if we don't find the subscription that shouldn't happen. That means something went wrong with our database or with their set up. So I'm going to throw a very clear exception so we know that something is not right and we probably need to check into it.

Find it at the bottom or return subscription. Now we have an easy, safe way to take the stripe subscription ID, find our subscription run the table. Now that we have the subscription row on the table all we really need to do on this is call cancel. We already have a function set up that makes this subscription row look cancelled. Actually I'm going to add a new method to our subscription helper that makes this even easier. Let's open that up and at the bottom make a new pop up function called fully cancel subscription. Take in the subscription entity, then below, really simple, we'll just say subscription error cancel. Then we'll actually use the entity manager to persist and save this and the database. Finally that means that in our controller we can use this. Above the switch, because I think we will need the subscription helper a few times, we'll make a new subscription helper variable set to this arrow, get subscription helper. Then down in our case you can finally say, subscription helper, arrow, fully cancel subscription and that's it. There's some set up to get the web hook controller working but now we have a really nice framework for handling this type and also any other types that we'll need to handle a second.

Course we have no way to test this. It's not something we're going to talk about in a second because I just kind of have to trust that I coded all of this correctly which is a big thing to ask when you're dealing with payments. Before we talk about that, the last thing I'll say is that since this is local, when we actually deploy this up to our beta or production servers, we need to remember to actually add a new web hook that points to this URL. For example, our cool site dot com, slash, web hooks, slash, stripe so that stripe will actually start delivering these things to your end points.
