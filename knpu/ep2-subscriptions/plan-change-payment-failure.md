# Plan Change Payment Failure

So upgrading and downgrading works great. You can downgrade to the Farmer Brent if we want to. It tells us we'll have a balance of $99 for downgrading to that account. We can see that on our customer, who suddenly has this credit on their account of $99.84. If you change to the New Zealander, you'll notice it says $0 because that amount due automatically takes into account any credit they have in their account. You can kind of upgrade, downgrade, upgrade, downgrade and it works good. Now, there's one problem and that's if the card they have on file fails when they try to upgrade or downgrade.

First, let's see what happens in this situation. Let's get a fresh subscription. We'll check out using a functional card. Now we have a fresh, normal subscription. In our account area, we can update the card to one that we know will fail. Specifically, it's this one, ending in 0341. This will attach to our account okay, but once we try to use it, it's going to fail. I check change to New Zealander. We'll be charged $99.16 immediately.

We hit okay, and this time something blows up in the HX Comp. You can see down here with this red over the 500. In fact if we open up the profiler for that, we can see the exception. "Your card was declined." Clearly, we didn't handle it very well. Then actually the problem is even a little worse than we thought. If we refresh on our customer, you'll see the failed payment, but you'll also see that the subscription went through. It shows them on the New Zealander. To make matters worse, there's an unpaid invoice, which represents what they should've been charged. This is an unpaid, or actually keep retrying this.

It kind of worked, but not at all on the way that we wanted it to. We need to handle this in a lot better way. Here's what we're going to do. The problem exists entirely in Stripe client, when we called this arrow, create invoice, because this might fail. In fact, let's go up to that function. This is the function that we use at checkout, even if there is no subscription. If the user just buys a couple individual products, we ultimately create an invoice. The problem is when an invoice fails to pay, it's going to continue to retry it. Instead of doing that, what I want to do is actually close the invoice and have the entire transaction fail.

That will make it so that we don't continue trying to pay this invoice. Surround the pay with a try, and then we'll catch the Stripe slash error slash card exception. Here, we'll say invoice arrow close equals true, then invoice arrow save. This tells Stripe, this invoice is null, stop trying to charge it. Then we're still going to throw the exception because something bad happened. Second, down at other function, if we fail to create the invoice, then we need to not change this Stripe subscription plan.

We'll make a new variable called original plan id equals Stripe subscription arrow plan, arrow id. Now, surround the create invoice with a try, and then we'll catch the same error. Stripe slash error slash card. What we want to do here is actually change the Stripe subscription back to the one it was a second ago. Stripe arrow plan equals original plan id. Here's the tricky part. I want you to also say, Stripe subscription arrow prorate equals false.

Here's the problem. When we originally changed the plan up here, that causes those two pro-ration invoice items to happen. One that gives you a credit for the amount that you've already paid for, and one that charges you for the amount that's left of the month. If the invoice fails to pay, then the invoice containing those invoice items is closed. Meaning effectively, those invoice items are deleted, which is good. That's what we want. Now down here when we change from the new plan back to the old plan, we don't want two new pro-ration invoices in reverse being created.

By saying prorate equals false, it says change the plan back to the original, but don't create any of those pro-ration invoice items. Just change the plan back. Finally, call Stripe subscription arrow save, then once again, I'm still going to throw the E because there's still something exceptional happening. That fixes the problem in Stripe. The last thing we need to do is give the user a better a experience.

Let's switch out of our controller on change plan action, let's surround the change plan call, which might fail, with one last try catch. I know, it's a little crazy. Catching that same Stripe error card exception. This happens, we just want to show the user a nice message and tell them what happened with their card. We'll return a new JsonResponse with a message key set to E arrow get message, which will be something like, "Your card was declined."

Then we'll be returning 400 status codes so that that looks like it failed when it came back in JavaScript. Finally, in our count tablet, in addition to the dot done, let's add a dot fail. This will be called, because we'll be returning 400 status code, and that gets a JQSHR object as an argument. It's a little bit different than the done. In here, we'll use suite alert just to show one last message. We'll give it a title of, plan change failed. Give it test of JQSHR dot response Json dot message. That'll be the message key we return from our response. Then we'll give it a type of error.

To test that, we're going to need to go back because things are totally messed up on our user right now. Just completely refresh and check out the fresh Farmer Brent. Check out using our fake, functional credentials. Go to our count. Update the card with the non-functional credentials, 010341, and now let's change to the New Zealander. Actually before we do that, let me refresh the customer inside of Stripe so we can see what it looks like right now. There's no customer balance, because we've used all of it. We're currently, our latest subscription is on the Farmer Brent. We change to the New Zealander, hit okay, and this time, it fails with, "Your card was declined."

If we look over and refresh the customer page, we'll still see some important stuff. Look, there's no balance still, which is good. We can see that there was a failed payment. We're still on the Farmer Brent subscription. Down here, you can see that invoice as unpaid, but it's been closed, which means it won't actually try to charge us again. At the bottom you can see even more stuff that happened behind the scenes, if you look at the events. You can see in very quick succession, we upgraded to the Farmer Brent plan, the pro-ration invoice adds are created, the invoice was created, the invoice was failed to be paid. We changed the invoice to closed, and we downgraded back to the Farmer Brent plan.

A lot of stuff going on behind the scenes to give us the exact situation that we want. Now, truly, this is rock solid.
