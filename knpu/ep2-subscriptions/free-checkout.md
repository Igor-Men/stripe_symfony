# Free checkout

If you create a really big coupon, then checkout might actually be completely free. Let's do that. Click on "Coupon" section, let's add one that's worth $500 called super sheep. Then go to our checkout and apply our new code. Perfect. So I have my cart set up to be smart and not give us a negative number. So Kraken knows that this is $0. The problem is, we still have a checkout form over here, and if you still, for some reason, want to force the user to actually put in their credit card information just to checkout for free, then you don't need to change anything. It won't charge the user, but it will put the credit card on file for them. But that's probably not what you want, because you want to make it as easy as possible for this user to checkout free.

So I want to hide this checkout form if it's free. First we're gonna do that in the template. Inside checkout, the dates from Twig, we'll go down to the client form down here, we'll say "if cart dot total with discount is greater than zero, then we want to show that." Otherwise, we're just gonna show a very simple checkout button, that says "checkout for free." So I put in "button" type in "submit". Give it a couple of classes, and we'll say "checkout for free". So now, if we refresh, boom. Goes away and checkout for free.

Now still, there's not a lot of logic that needs to change. Stripe is already set up to understand not to charge this user. The one funny thing though, is up until now, inside of our order controller, we're expecting there to be a token. Remember that's the token that we get back from Stripe, after submitting that credit card information. We then pass that to charge customer, down here, and we use this token when we either- to attach the customer.

So the only thing that needs to change, is we need to make sure our code is smart enough to not try to attach this token to the customer, because there won't be a token in this case. At the top, I'm first gonna add some code just to be really careful. I'm gonna say "If there is no token, and this get shopping cart, get total discount, when discount is greater than zero" that means we have a problem. That means this was not a free order, but somehow we're missing the token. That shouldn't be allowed. So store exception, to indicate this.

Next, instruct client when you create the customer, we pass in the token. So let's find create customers out here. Now, we need to make sure that we're a little careful, because there's no payment token, we don't want to pass a source. Stripe's gonna get angry if we pass that empty source, so instead, correcting data variable, and just the email inside of that. Then when you call up Stripe, customer create, passive data. Now we say, "if payment token, then we will add the source key equal to payment token". So that'll take care of any weirdness there.

The other situation is when we call "update customer card", well, clearly, if we don't have a token, then there's no customer card update. So we don't want to call this function. So we'll say "if token, then we will call that line". However, in both cases, we do need a Stripe customer, because we end up using it in other places. So anything else, we need to "fetch" the Stripe customer. So in Stripe client, we're gonna add a new method for that all the way at the bottom, very simple, call it function, via customer, taking the user object, it'll just return, slash stripe. Slash customer. Retrieved, say user, arrow, get Stripe customer ID.

So back in order controller, we can say Stripe customer equals Stripe client, arrow, client customer as the user. So in all cases now, we end up with a Stripe customer object, which is good. Now the last thing that we need to change here is down in "update card details" inside of subscription helper. Update card details is the thing that actually looks on sources, which are the card details, and then updates the last four in the brand. Now, as I mentioned earlier, technically you can attach many cards onto the user, that's why we just- but we just attach one. That's all we're looking for, just the zero index here.

But if the card doesn't have a customer on them, then there's nothing to update. So let's just add an if statement here that says "if not Stripe customer, arrow, sources, arrow, data" meaning it's an empty array, then just return. Because the customer may not have a card on file. And that is everything. So really, checkout for free is just a matter of handling a couple of details, making sure your code can deal with not having a Stripe token. So let's checkout for free, and there we go.

Inside of Stripe, checkout our customer, and we see that there's no payment for this, because he didn't actually pay anything, but down here, there's an invoice for zero dollars, and you have an active subscription. The only other- we've just introduced the idea that customers in our system may or may not have a card attached to them. This causes one slight problem with our web hooks, so open up the web hook controller. Go down to the invoice dot payment failed- oh, and actually, let me fix my old error there with my typo. Do not typo those.

Anyways, back to invoice dot payment fail. The only reason that we are listing it on this web hook, is so that we can send the user email when there's a problem charging their credit card. So we say something like "Hey, we're having a problem charging your credit card, please go to your account page and update your credit card". So the only weird thing now, is that if they checked out for free, after their first month, Stripe's gonna have problems charging them. It's going to send this web hook. So in those cases, what we really want to say is "Hey, I hope you enjoyed your free month, if you want to continue, go add a credit card to your account page." So it's just a language thing that we want to be really smooth with for our user.

So to figure out which situation we're in, we're first gonna fetch the Stripe customer, by saying this "arrow, get Stripe client, arrow, find customer" we pass then, our user object. The reason we do that, is because now, we can create a new variable, called "Has card on file". We can set that to a count of "Stripe customer, arrow, sources, arrow, data" and make sure that's greater than zero. So now we can send an email down here, or we can use "Has card on file" to customize this. These are the small details that really make e-commerce difficult.
