# Canceling on Our Site

When we cancel, we are now telling Stripe that we want to cancel, so the subscription is being canceled on Stripe's side, but we need to update our database, so that we know the user has canceled, and specifically, that means we need to do something with the subscription row in the subscription table. Either we need to delete the row, or somehow we need to mark this subscription as not being active anymore, as being canceled, still active, but it is in a canceled state.

Inside profile controller, right after we cancel the subscription in Stripe, let's grab that subscription object by saying, "This, get user." ... "Subscription equals this, get user, arrow, get subscription." Now, here's the plan: We are not going to delete the subscription from the subscription table, because the subscription is still active until the period end. Instead, what we're going to do is we're going to set this "ends at" field to when the subscription will expire, and then we'll be able to tell whether or not this subscription is still active, meaning it's before that "ends at" date, or it's inactive, because it's after the "ends at" date.

Down at the bottom, let's make a helpful function to do this, called "Public function deactivate subscription." ... We know the user has paid through the end of the period, so we can use that to say, "This arrow ends at equals this arrow billing period ends at." That's a really simple way of knowing when this subscription will expire. I'm also going to set "billing period ends at" to NULL, just so we know that there won't be another bill that's going to be sent when that period ends.

Now, deactivating the subscription in the controller is as easy as saying, "Subscription, arrow, deactivate subscription," and then we're going to save this to the database, and persist subscription, and flush. That should do it. Let's give this guy a try. Make sure you're in your account area. There's our "cancel subscription" button. Click that, and looks good. You double check it inside your Stripe dashboard, you should see that the most recent subscription is canceled. ... Perfect, so active, but it's going to cancel.

If you look at this page, here, all the information still says, "Active." It still says, "Next billing's going to happen at," so our database is probably updated correctly, but we now need to update our account page to reflect that. This is controlled in our account.html.twig. I need an easy way to know whether or not a subscription is active, and if it is active, whether or not it's in that canceled state.

To help with this, let's create 2 methods inside of our subscription object. First, "Public function is active," meaning does the user still have an active subscription? We know they do. "If ends at equals equals NULL," then that means they have a subscription object and it has not been canceled, or, "This arrow ends at, is greater than, right now, new date time," meaning it is canceled, but it's ending in the future.

The other method we're going to want here is, "Public function is canceled," so if it is active, has the user actually canceled it or not? This will simply be, "Return, this arrow ends at, does not equal, NULL." Ends at a set, "Is canceled," if ends at is NULL, "Is not canceled."

To make it even easier to know if a user has an active subscription, I'm also going to go into the user class, and add a new public function here, called, "Has active subscription." A user has an active subscription if they have a subscription object related to them, and that subscription object is active. That will save us a little bit of typing when we need to check whether or not the user has an active subscription. We're going to use that immediately inside of our account template, in a few places.

First, this cancel subscription button should obviously only be there if the user has an active subscription. Let's add an if statement that says, "If app dot user dot has active subscription," and then, even if the user has an active subscription, they may have already canceled it, so we only want to show this button if they have not canceled it, so add another if statement, says, "If app dot user dot subscription dot is canceled," then I'll add a little to-do, to add a re-activate button. In other words, the user has canceled, but they've come back and said, "Oh no, I actually want to have the service." Of course, if they're active and haven't canceled, that's where we want to have our button.

We'll finish up the "end if," and add another "end if." Perfect. I'm actually going to copy these first 2 lines, because we're going to reuse these again, down here. This is the section that tells us whether or not we have an active subscription, and now we have 3 states. We have "active," "active but canceled," and, "none." In place of the first if statement, I'm going to place those 2 if statements, and we know that if a subscription is canceled, let's go to a label dash warning called, "Canceled," else we know it's really active.

If a user does not have any type of active subscription, we'll just say "none," like we did before. I'll copy just the first part of that if statement, and I'll keep going down here. Of course, in the next billing period, should only show if the user has an active subscription. They may have a subscription object, but it may be canceled, and if it's canceled, we don't want to show the next billing period.

Finally, same thing down here with credit card. It might just be confusing if we have the user's credit card information stored in the database, but they don't have an active subscription, so let's just surround that with the same if statement.

We had a lot of new data to use in the database. When we refresh, it's perfect. You can see the "to do, add, reactivate" button here, canceled subscription, and actually, the only problem is, the next billing at and credit card should not be showing. ... Ah, that makes sense, because we need to actually add a little bit more logic here. ... Ah, and that makes sense, because the active subscription checks if it's active, even if it's canceled, so let's actually, in user, make a new method here, called "Public function has active non-canceled subscription," and we're going to return this, "Has active subscription and and not this arrow get subscription arrow is canceled." We can use this method whenever we need to know that bit of information.

Refresh, now we're in good shape. Okay. Now that we've allowed the user to cancel, let's allow them to re-activate if they want to.
