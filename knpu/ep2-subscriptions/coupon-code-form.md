# Coupon Code Form

Let's talk about something fun. How about coupon codes. Here's the new goal, when we check out I want to be able to add a coupon code here. Fortunately Stripe supports this so it makes our job pretty simple. In fact, inside of your Stripe dashboard, there is a coupon section. You create your coupons right inside of here. You'll either choose your percent off or amount off. To make things simple for us, I'm only going to support coupons that are specific amount off. Let's create one that saves us fifty dollars. You can also use duration month or forever, so if they have a subscription they can get fifty dollars off per month. That's up to you. Then you're going to create some unique code for this. Let's create something called cheek cheap. I'm using all capitalization, these are case sensitive. If you want you can make it so that they can only use this one time. I'm going to create my coupon codes right through the interface right here. If you want to create some sort of admin section on your side that creates through the API, you can do that if you want to because coupons are part of the API.

Totally up to you. The first step of this is actually adding something to our check out page that we are aware that they have a coupon, we've validated it, and we've updated their amounts. First let me add something to our cart. Now I'm going to open the order/check out the html [inaudible 00:01:58] template. Right below the cart table here we're going to add a little link for the coupon code. Let's make a button, give some classes. I'll give is a JS class of show code form which we'll use in Java script in a second. We'll say I have a coupon code. Now for the actual coupon form, to save us some time, in your tutorial directory you should have a coupon form dot twig template. Copy the code out of there, close that up, then paste it right here into our template. The important things I've noticed is that this is hidden by default, it also runs a class that we'll use in a second, and it just has one field in it whose name is code. When we resubmit this we'll be looking for the code. Now up top I'll copy the JS show code form and in the Java script section I want a new script tag, a new document dot ready blog.

We'll find that element and say on click call this function, we'll call E dot prevent default like normal, and then all we want to do is show that coupon code form. Specifically we want to find JS code form. We'll keep it simple, we'll just say dot show. Perfect. Now if we refresh, click this link, and we have the little code form. When we hit add we're going to have this sent to a new endpoint which is going to validate that code inside of Stripe and actually attach it to our user's shopping cart. Shopping cart is not something we've talked about in this tutorial, but it keeps track of what subscriptions we have available and also what coupon code. That means when we actually go to checkout and charge the user, we'll know that the user has a coupon code that we need to tell Stripe about. To create this new endpoint, open up order controller. Near the bottom I'll create a new public function add coupon action with the URL of /checkout/coupon and we'll give the name order add coupon. Also for good measure I'll add at method post since we'll have this be posting here.

With just that in place I'm going to go back to our checkout template and update the form action to point here. I'll use the path function and then base order add coupon. Perfect. Now to read the post parameter for code we'll need to request object. Then we'd say dollar send code equals request error request error get code, and that will get the post parameter whose name is code. Just in case somebody hits submit with it empty, let's add a little validation saying if not code this error add flash error. We'll say missing coupon code. Then we will redirect back to our checkout page with that error. Cool, so at this point all we need to do is go and talk to Stripe and ask them, "Is this a valid coupon code in your system?" If it is, we'll add it to our shopping cart and then we can use it later on checkout. As I just showed you, coupon is actually a object in Stripe's API, so we just need to make an API request out to fetch a specific coupon. As usual, we're going to do that inside of our Stripe client. At the bottom here let's create a new public function called find coupon.

We'll pass it the coupon code. Here we'll just return Stripe/coupon::retrieve and that will pass us the code, which is the primary key for the coupon. Now inside of the order controller we can say Stripe coupon equals this arrow get Stripe onto store client arrow find coupon and code. If that is an invalid code, that's going to throw and exception and we'll handle that in a second. Just for right now, let's dump that Stripe coupon and have a die statement so we can see what it looks like. All right, go back, refresh, hit "I have a coupon code," and let's put in our CHEAP SHEEP, and that is case sensitive. Okay, cool so it found our coupon object. In field incentive values it has the ID, it also has the amount off in cents, which is going to be really important for us. It also has other information like duration in case you are supporting recurring duration and you want to be able to tell the user this is going to be applied once or many times. You might read and use that off right there. For us, we're going to add this to shopping cart by saying this arrow get shopping cart.

I've already prepared the shopping cart to have a place where it stores the discounts, so just say set coupon code, and what it wants is it wants what the actual code is. The second argument here is the value in dollars for that code. Lets use Stripe coupon arrow amount underscore off divided by a hundred to put that into dollars. We're just reading this amount off here to put it into fifty dollars. Of course we'll add a flash message coupon applied, and then redirect back to our checkout page. Now I'll go back, and we can just refresh this to resubmit that. Boom, instantly we see coupon applied. You don't see any evidence of that in our cart yet, so it's not really obvious if my shopping cart is working. Let me tell you, inside of our checkout template when we print the total we call it cart dot total. The way that I made the shopping cart, when call up a total on it it totals up all of your products and all of your subscription plans, but it doesn't take into account your discounts. I did that because the total is the amount that we actually want to tell Stripe to charge us, to charge the user.

You'll see why in a second. For displaying the user how much they're going to get charged, we have another method here called get total with discount, which actually goes and subtracts the coupon code value. To see the update down here we'll say total with discount. Now that shows forty-nine dollars. Now, also to be a little more friendly let's add an end statement here that says if cart dot coupon code then we know that we're going to want to show a little row with that in it. Let's print out cart dot coupon code here. Then down here we'll print out cart dot coupon code value. Maybe even a little minus in front. Now, refresh, now that looks really nice. It'll be nicer with the word coupon in front. We've validated the coupon with Stripe, we attached the coupon to our shopping cart, and now when we check out we need to tell Stripe to apply this coupon code to their account. Let's do that now.
